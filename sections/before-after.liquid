{% comment %}
  Before & After Section
  Displays interactive before/after image slider to showcase product results.
{% endcomment %}

{% style %}
  #before-after-{{ section.id }} {
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    background-color: {{ section.settings.background_color }};
  }

  #before-after-{{ section.id }} .before-after__header {
    text-align: {{ section.settings.heading_alignment }};
    margin-bottom: {{ section.settings.heading_spacing }}px;
  }

  #before-after-{{ section.id }} .before-after__heading {
    color: {{ section.settings.heading_color }};
  }

  #before-after-{{ section.id }} .before-after__description {
    color: {{ section.settings.text_color }};
  }
{% endstyle %}

<div id="before-after-{{ section.id }}" class="before-after">
  <div class="before-after__container">
    {% liquid
      assign ba_heading = shop.metafields.custom.before_after_heading | default: section.settings.heading
      assign ba_description = shop.metafields.custom.before_after_description | default: section.settings.description
    %}

    {% if ba_heading != blank or ba_description != blank %}
      <div class="before-after__header">
        {% if ba_heading != blank %}
          <h2 class="before-after__heading">{{ ba_heading }}</h2>
        {% endif %}

        {% if ba_description != blank %}
          <p class="before-after__description">{{ ba_description }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <div class="before-after__slider-wrapper">
        <div class="before-after__slides" data-slider-id="before-after-{{ section.id }}">
          {% for block in section.blocks %}
            {% liquid
              assign before_img = shop.metafields.custom[block.settings.before_image_metafield] | default: block.settings.before_image
              assign after_img = shop.metafields.custom[block.settings.after_image_metafield] | default: block.settings.after_image
              assign caption_text = shop.metafields.custom[block.settings.caption_metafield] | default: block.settings.caption
            %}

            <div class="before-after__slide {% if forloop.first %}is-active{% endif %}" {{ block.shopify_attributes }}>
              <div class="before-after__comparison" data-comparison>
                {% if section.blocks.size > 1 %}
                  <button class="before-after__nav-arrow before-after__nav-arrow--prev" data-nav="prev" aria-label="Previous comparison">
                    ‹
                  </button>
                {% endif %}

                <div class="before-after__image-wrapper">
                  <div class="before-after__before">
                    {% if before_img != blank %}
                      {{ before_img | image_url: width: 1200 | image_tag: loading: 'lazy', alt: 'Before' }}
                    {% else %}
                      <div class="before-after__placeholder before-after__placeholder--before">
                        <div class="before-after__placeholder-text">BEFORE</div>
                      </div>
                    {% endif %}
                    <span class="before-after__label before-after__label--before">{{ block.settings.before_label }}</span>
                  </div>

                  <div class="before-after__after">
                    {% if after_img != blank %}
                      {{ after_img | image_url: width: 1200 | image_tag: loading: 'lazy', alt: 'After' }}
                    {% else %}
                      <div class="before-after__placeholder before-after__placeholder--after">
                        <div class="before-after__placeholder-text">AFTER</div>
                      </div>
                    {% endif %}
                    <span class="before-after__label before-after__label--after">{{ block.settings.after_label }}</span>
                  </div>

                  <div class="before-after__slider" data-slider>
                    <div class="before-after__slider-button" data-slider-button>
                      <span class="before-after__slider-arrows">⟷</span>
                    </div>
                  </div>
                </div>

                {% if section.blocks.size > 1 %}
                  <button class="before-after__nav-arrow before-after__nav-arrow--next" data-nav="next" aria-label="Next comparison">
                    ›
                  </button>
                {% endif %}
              </div>

              {% if caption_text != blank %}
                <p class="before-after__caption">{{ caption_text }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        {% if section.blocks.size > 1 %}
          <div class="before-after__dots">
            {% for block in section.blocks %}
              <button
                class="before-after__dot {% if forloop.first %}is-active{% endif %}"
                data-slide="{{ forloop.index0 }}"
                aria-label="Go to comparison {{ forloop.index }}"
              ></button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="before-after__empty">
        <p>Add before/after comparison blocks to showcase your product results.</p>
      </div>
    {% endif %}
  </div>
</div>

{% stylesheet %}
  .before-after {
    width: 100%;
  }

  .before-after__container {
    max-width: var(--page-width);
    margin: 0 auto;
    padding: 0 var(--page-margin);
  }

  .before-after__header {
    margin-bottom: 3rem;
  }

  .before-after__heading {
    font-size: clamp(2rem, 4vw, 3rem);
    margin-bottom: 1rem;
  }

  .before-after__description {
    font-family: var(--font-body--family);
    font-size: 1.125rem;
    line-height: 1.6;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
  }

  .before-after__slider-wrapper {
    max-width: 1200px;
    margin: 0 auto;
  }

  .before-after__slides {
    position: relative;
  }

  .before-after__slide {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .before-after__slide.is-active {
    display: block;
    opacity: 1;
  }

  .before-after__comparison {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1rem;
    user-select: none;
  }

  .before-after__image-wrapper {
    position: relative;
    flex: 0 0 auto;
    width: 100%;
    max-width: 1200px;
    padding-bottom: 100%;
    overflow: hidden;
    background: #F5F1E8;
    cursor: ew-resize;
    border-radius: 4px;
  }

  .before-after__before,
  .before-after__after {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .before-after__before {
    z-index: 1;
  }

  .before-after__after {
    z-index: 2;
    clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
    transition: clip-path 0.05s ease-out;
  }

  .before-after__before img,
  .before-after__after img,
  .before-after__placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .before-after__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #E8DCC8 0%, #D4C4B0 100%);
  }

  .before-after__placeholder--before {
    background: linear-gradient(135deg, #B8A89A 0%, #9D8D7F 100%);
  }

  .before-after__placeholder--after {
    background: linear-gradient(135deg, #F5EBE0 0%, #E8DCC8 100%);
  }

  .before-after__placeholder-text {
    font-family: var(--font-heading--family);
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.4);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .before-after__slider {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 3px;
    height: 100%;
    background: #fff;
    z-index: 3;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    transition: left 0.05s ease-out;
  }

  .before-after__slider-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: ew-resize;
    touch-action: none;
  }

  .before-after__slider-arrows {
    font-size: 24px;
    color: #4A3F35;
    font-weight: bold;
  }

  .before-after__label {
    position: absolute;
    bottom: 1rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.95);
    color: #4A3F35;
    font-family: var(--font-body--family);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: 2px;
    z-index: 4;
  }

  .before-after__label--before {
    left: 1rem;
  }

  .before-after__label--after {
    right: 1rem;
  }

  .before-after__caption {
    text-align: center;
    font-family: var(--font-body--family);
    font-size: 0.9375rem;
    line-height: 1.5;
    color: var(--color-foreground);
    opacity: 0.8;
    margin: 0 0 2rem 0;
  }

  .before-after__nav-arrow {
    flex: 0 0 auto;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.9);
    color: #4A3F35;
    font-size: 32px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
  }

  .before-after__nav-arrow:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    transform: scale(1.1);
  }

  .before-after__dots {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .before-after__dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #4A3F35;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  .before-after__dot.is-active,
  .before-after__dot:hover {
    background: #4A3F35;
  }

  .before-after__empty {
    text-align: center;
    padding: 3rem;
    background: rgba(196, 165, 116, 0.1);
    border-radius: 4px;
    border: 2px dashed rgba(196, 165, 116, 0.3);
  }

  .before-after__empty p {
    font-size: 1rem;
    color: #C4A574;
    font-weight: 500;
    margin: 0;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .before-after__header {
      margin-bottom: 2rem;
    }

    .before-after__heading {
      font-size: 1.75rem;
    }

    .before-after__description {
      font-size: 1rem;
    }

    .before-after__comparison {
      gap: 0.75rem;
    }

    .before-after__label {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }

    .before-after__slider-button {
      width: 40px;
      height: 40px;
    }

    .before-after__slider-arrows {
      font-size: 20px;
    }

    .before-after__placeholder-text {
      font-size: 2rem;
    }

    .before-after__nav-arrow {
      width: 40px;
      height: 40px;
      font-size: 28px;
    }
  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function() {
    const slidesContainers = document.querySelectorAll('[data-slider-id^="before-after-"]');

    slidesContainers.forEach(function(slidesContainer) {
      if (!slidesContainer) return;

      const parentSection = slidesContainer.closest('.before-after');
      const slides = slidesContainer.querySelectorAll('.before-after__slide');
      const dots = parentSection.querySelectorAll('.before-after__dot');
      const prevButtons = parentSection.querySelectorAll('[data-nav="prev"]');
      const nextButtons = parentSection.querySelectorAll('[data-nav="next"]');
      let currentSlide = 0;
      let activeWrapper = null;

      // Shared event handlers for document (only one set per section)
      function handleMouseMove(e) {
        if (!activeWrapper) return;
        updateSliderPosition(activeWrapper, e.clientX);
      }

      function handleMouseUp() {
        activeWrapper = null;
      }

      function handleTouchMove(e) {
        if (!activeWrapper) return;
        updateSliderPosition(activeWrapper, e.touches[0].clientX);
      }

      function handleTouchEnd() {
        activeWrapper = null;
      }

      function updateSliderPosition(wrapperData, clientX) {
        const rect = wrapperData.wrapper.getBoundingClientRect();
        const x = clientX - rect.left;
        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));

        wrapperData.afterLayer.style.clipPath = `polygon(${percentage}% 0, 100% 0, 100% 100%, ${percentage}% 100%)`;
        wrapperData.slider.style.left = `${percentage}%`;
      }

      // Initialize interactive before/after sliders
      slides.forEach((slide) => {
        const comparison = slide.querySelector('[data-comparison]');
        if (!comparison) return;

        const wrapper = comparison.querySelector('.before-after__image-wrapper');
        const afterLayer = comparison.querySelector('.before-after__after');
        const slider = comparison.querySelector('[data-slider]');

        const wrapperData = { wrapper, afterLayer, slider };

        // Mouse events
        wrapper.addEventListener('mousedown', (e) => {
          activeWrapper = wrapperData;
          updateSliderPosition(wrapperData, e.clientX);
        });

        // Touch events
        wrapper.addEventListener('touchstart', (e) => {
          activeWrapper = wrapperData;
          updateSliderPosition(wrapperData, e.touches[0].clientX);
        });
      });

      // Add document-level listeners only once per section
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      document.addEventListener('touchmove', handleTouchMove);
      document.addEventListener('touchend', handleTouchEnd);

      // Slideshow navigation
      function showSlide(index) {
        slides.forEach((slide, i) => {
          slide.classList.toggle('is-active', i === index);
        });
        dots.forEach((dot, i) => {
          dot.classList.toggle('is-active', i === index);
        });
        currentSlide = index;
      }

      prevButtons.forEach((prevButton) => {
        prevButton.addEventListener('click', () => {
          const newIndex = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
          showSlide(newIndex);
        });
      });

      nextButtons.forEach((nextButton) => {
        nextButton.addEventListener('click', () => {
          const newIndex = currentSlide === slides.length - 1 ? 0 : currentSlide + 1;
          showSlide(newIndex);
        });
      });

      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const slideIndex = parseInt(dot.dataset.slide);
          showSlide(slideIndex);
        });
      });
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "Before & After",
  "settings": [
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Real Results",
      "info": "Can be overridden by shop metafield: custom.before_after_heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "See the transformative power of our products through real customer results",
      "info": "Can be overridden by shop metafield: custom.before_after_description"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#4A3F35"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Description color",
      "default": "#4A3F35"
    },
    {
      "type": "range",
      "id": "heading_spacing",
      "min": 20,
      "max": 80,
      "step": 4,
      "unit": "px",
      "label": "Spacing below heading",
      "default": 48
    },
    {
      "type": "header",
      "content": "Section styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "comparison",
      "name": "Before/After Comparison",
      "settings": [
        {
          "type": "header",
          "content": "Before Image"
        },
        {
          "type": "image_picker",
          "id": "before_image",
          "label": "Before image",
          "info": "Can be overridden by shop metafield specified below"
        },
        {
          "type": "text",
          "id": "before_image_metafield",
          "label": "Before image metafield key (optional)",
          "info": "Example: before_image_1 (will use shop.metafields.custom.before_image_1)"
        },
        {
          "type": "text",
          "id": "before_label",
          "label": "Before label",
          "default": "Before"
        },
        {
          "type": "header",
          "content": "After Image"
        },
        {
          "type": "image_picker",
          "id": "after_image",
          "label": "After image",
          "info": "Can be overridden by shop metafield specified below"
        },
        {
          "type": "text",
          "id": "after_image_metafield",
          "label": "After image metafield key (optional)",
          "info": "Example: after_image_1 (will use shop.metafields.custom.after_image_1)"
        },
        {
          "type": "text",
          "id": "after_label",
          "label": "After label",
          "default": "After"
        },
        {
          "type": "header",
          "content": "Caption"
        },
        {
          "type": "textarea",
          "id": "caption",
          "label": "Caption",
          "default": "After 4 weeks of daily use",
          "info": "Can be overridden by shop metafield specified below"
        },
        {
          "type": "text",
          "id": "caption_metafield",
          "label": "Caption metafield key (optional)",
          "info": "Example: before_after_caption_1 (will use shop.metafields.custom.before_after_caption_1)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Before & After",
      "blocks": [
        {
          "type": "comparison",
          "settings": {
            "before_label": "Before",
            "after_label": "After",
            "caption": "After 4 weeks of daily use"
          }
        },
        {
          "type": "comparison",
          "settings": {
            "before_label": "Before",
            "after_label": "After",
            "caption": "After 8 weeks of consistent application"
          }
        },
        {
          "type": "comparison",
          "settings": {
            "before_label": "Before",
            "after_label": "After",
            "caption": "After 12 weeks of transformation"
          }
        }
      ]
    }
  ]
}
{% endschema %}
